name = "hoot-server"
main = "server/server-worker.js"
compatibility_date = "2024-11-04"
compatibility_flags = ["nodejs_compat"]

# Development configuration
[dev]
port = 8008
local_protocol = "http"

# Durable Objects configuration
[durable_objects]
bindings = [
  { name = "USER_DATA", class_name = "UserDataDO" },
  { name = "FAVICON_CACHE", class_name = "FaviconCacheDO" },
  { name = "MCP_CONNECTION_POOL", class_name = "MCPConnectionPoolDO" }
]

# Migration history acknowledgment
# Note: DOs already exist in production, so we acknowledge v1 and v2 without changes
[[migrations]]
tag = "v1"
# DOs created in initial deployment - acknowledged for history

[[migrations]]
tag = "v2"
# Code updates only - no schema changes

[[migrations]]
tag = "v3"
deleted_classes = ["MCPConnectionDO"]
# Removed MCPConnectionDO - using per-request connections instead

[[migrations]]
tag = "v4"
new_classes = ["MCPConnectionPoolDO"]
# Added MCPConnectionPoolDO for persistent MCP connections

# Environment variables (non-secret)
[vars]
FRONTEND_URL = "http://localhost:8009"
# PORTKEY_ORG_ID and PORTKEY_WORKSPACE_SLUG should be set as secrets

# Secrets (set with: wrangler secret put SECRET_NAME)
# Run these commands to set secrets:
# wrangler secret put JWT_PRIVATE_KEY
# wrangler secret put JWT_JWKS
# wrangler secret put PORTKEY_ORG_ID
# wrangler secret put PORTKEY_WORKSPACE_SLUG

# Production configuration
# Note: Set CLOUDFLARE_ACCOUNT_ID environment variable instead of hardcoding account_id
# Add to your .env file: CLOUDFLARE_ACCOUNT_ID=your_account_id_here
[env.production]
name = "hoot-server-production"
vars = { FRONTEND_URL = "https://hoot.run" }

[[env.production.durable_objects.bindings]]
name = "USER_DATA"
class_name = "UserDataDO"

[[env.production.durable_objects.bindings]]
name = "FAVICON_CACHE"
class_name = "FaviconCacheDO"

[[env.production.durable_objects.bindings]]
name = "MCP_CONNECTION_POOL"
class_name = "MCPConnectionPoolDO"

# Note: Migrations removed - DOs already exist in production
# The base [[migrations]] at the top is sufficient for new deployments

# Staging configuration
[env.staging]
name = "hoot-server-staging"
vars = { FRONTEND_URL = "https://staging.hoot.yourdomain.com" }

[[env.staging.durable_objects.bindings]]
name = "USER_DATA"
class_name = "UserDataDO"

[[env.staging.durable_objects.bindings]]
name = "FAVICON_CACHE"
class_name = "FaviconCacheDO"

[[env.staging.durable_objects.bindings]]
name = "MCP_CONNECTION_POOL"
class_name = "MCPConnectionPoolDO"

# Note: Migrations removed - DOs already exist
# Use base [[migrations]] for fresh deployments only

